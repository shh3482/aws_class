<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<main layout:fragment="content" class="container">
		<h2>게시글 상세</h2>
		<div th:if="${post !=null}">
			<div class="mb-3">
				<label>제목: </label>
				<div th:text="${post.po_title}" class="form-control"></div>
			</div>
			<div class="input-group mb-3">
				<div class="form-control" th:text="'작성자: ' + ${post.po_me_id}">1</div>
				<div class="form-control" th:text="'조회수: ' + ${post.po_view}">2</div>
			</div>
			<div class="mb-3 d-flex justify-content-center">
				<button class="btn btn-up btn-outline-success me-3"
					th:onclick="|setLike(${post.po_num},1)|">추천</button>
				<button class="btn btn-down btn-outline-danger"
					th:onclick="|setLike(${post.po_num},-1)|">비추천</button>
			</div>
			<div class="mb-3">
				<label>내용 : </label>
				<div class="form-control" style="min-height: 300px;"
					th:text="${post.po_content}"></div>
			</div>
			<div class="mb-3" th:if="${!files.isEmpty()}">
				<label>첨부파일([[${files.size()}]])</label> <a
					th:each="file : ${files}" th:href="@{|/download/${file.fi_name}|}"
					th:text="${file.fi_ori_name}" class="form-control mb-3"
					th:download="${file.fi_ori_name}"></a>
			</div>
			<form th:action="@{/post/update/{num}(num=${post.po_num})}"
				th:if="${#authentication.name == post.po_me_id}" method="get">
				<button class="btn btn-outline-warning">게시글 수정</button>
			</form>
			<form th:action="@{/post/delete/{num}(num=${post.po_num})}"
				th:if="${#authentication.name == post.po_me_id}" method="post">
				<button class="btn btn-outline-danger">게시글 삭제</button>
			</form>
			<hr>
			<h1>댓글</h1>
			<div class="comment-container">
				<div class="comment-list">
					<div class="comment-item form-control">
						<div class="d-flex justify-content-between mb-3">
							<div>작성자</div>
							<div>2026.01.09. 17:10</div>
						</div>
						<hr>
						<div class="mt-3">댓글 내용</div>
					</div>
					<div class="comment-item form-control">
						<div class="d-flex justify-content-between mb-3">
							<div>작성자</div>
							<div>2026.01.09. 17:10</div>
						</div>
						<hr>
						<div class="mt-3">댓글 내용</div>
					</div>
				</div>
				<div class="comment-pagination"></div>
				<ul class="pagination justify-content-center">
					<li class="page-item"><a class="page-link"
						href="javascript:void(0);">Previous</a></li>
					<li class="page-item"><a class="page-link"
						href="javascript:void(0);">1</a></li>
					<li class="page-item"><a class="page-link"
						href="javascript:void(0);">2</a></li>
					<li class="page-item"><a class="page-link"
						href="javascript:void(0);">Next</a></li>
				</ul>
				<div class="comment-input">
					<form class="input-group">
						<textarea class="form-control"></textarea>
						<button class="btn btn-outline-success">등록</button>
					</form>
				</div>
			</div>
		</div>
		<div th:if="${post == null}">
			<h1>삭제되거나 등록되지 않은 게시글입니다.</h1>
		</div>
		<script type="text/javascript">
		const upBtn = document.querySelector(".btn-up");
		const downBtn = document.querySelector(".btn-down");
		async function setLike(postNum, state) {
			const postData = {
				// 보낼 데이터 채우기
				postNum,
				state
			};

			try {
				const response = await fetch('/post/like', {
					method : 'POST',
					headers : {
						'Content-Type' : 'application/json',
					// 스프링 시큐리티 사용 시 아래 주석 해제 (HTML 메타 태그에 토큰 정보가 있어야 함)
					// [csrfHeader]: csrfToken 
					},
					body : JSON.stringify(postData)
				});

				// 1. HTTP 응답 상태가 성공인지 확인
				if (response.ok) {
					// 서버가 단순 텍스트를 주면 text(), JSON을 주면 json()
					const result = await response.text();
					alert(result);
					loadLikeBtns();

				} else {
					// 2. 400, 500 에러 등에 대한 처리
					const errorText = await response.text();
					console.log("서버 오류: " + errorText);
				}

			} catch (error) {
				// 3. 네트워크 단절이나 문법 에러 등 아주 예외적인 상황
				console.error("통신 중 오류 발생:", error);
				alert("통신에 실패했습니다.");
			}
		}
		
		async function loadLikeBtns(){
			const postNum = [[${post.po_num}]];
			try{
				const response = await fetch('/post/like/count/' + postNum);
				if(response.ok){
					const result = await response.json();
					console.log(result);
					const up = result.up;
					const down = result.down;
					
					upBtn.innerText = `추천(${up})`;
					downBtn.innerText = `비추천(${down})`;
					checkLike();
				}else{
					console.log("추천/비추천 수 가져오기 실패");
				}
			}catch(error){
				console.error("예외 발생");
			}
		}
		loadLikeBtns();
		
		async function checkLike(){
			const postNum = [[${post.po_num}]];
			
			try{
				const response = await fetch('/post/like/check/' + postNum);
				
				if(response.ok){
					const result = await response.text();
					if(result == 0){
						return;
					}
					upBtn.classList.remove('btn-success');
					upBtn.classList.remove('btn-outline-success');
					
					downBtn.classList.remove('btn-danger');
					downBtn.classList.remove('btn-outline-danger');
					
					upBtn.classList.add(`btn-${result == 1 ? '' : 'outline-'}success`);
					downBtn.classList.add(`btn-${result == -1 ? '' : 'outline-'}danger`);
				}else{
					
					console.log("불러오기 실패");
				}
			}catch(error){
				console.error(error);
			}
		}
		
	</script>
	</main>
</body>
</html>